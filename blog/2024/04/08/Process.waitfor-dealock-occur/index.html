<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Process.waitFor() 이 영원히 끝나지 않는다. | 뉴뉴의 메모장</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://devyuseon.github.io/img/introduce.png"><meta data-rh="true" name="twitter:image" content="https://devyuseon.github.io/img/introduce.png"><meta data-rh="true" property="og:url" content="https://devyuseon.github.io/blog/2024/04/08/Process.waitfor-dealock-occur"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Process.waitFor() 이 영원히 끝나지 않는다. | 뉴뉴의 메모장"><meta data-rh="true" name="description" content="자바에서 외부 프로세스에 exec() 명령을 전달하고, waitFor() 메서드 사용시 행이 걸리는 이슈"><meta data-rh="true" property="og:description" content="자바에서 외부 프로세스에 exec() 명령을 전달하고, waitFor() 메서드 사용시 행이 걸리는 이슈"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-04-08T00:00:00.000Z"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://devyuseon.github.io/blog/2024/04/08/Process.waitfor-dealock-occur"><link data-rh="true" rel="alternate" href="https://devyuseon.github.io/blog/2024/04/08/Process.waitfor-dealock-occur" hreflang="en"><link data-rh="true" rel="alternate" href="https://devyuseon.github.io/blog/2024/04/08/Process.waitfor-dealock-occur" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="뉴뉴의 메모장 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="뉴뉴의 메모장 Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-47JM0E64J5"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-47JM0E64J5",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.504457c6.css">
<script src="/assets/js/runtime~main.b9300a1e.js" defer="defer"></script>
<script src="/assets/js/main.17c825b2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/sticky-note.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/sticky-note.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">뉴뉴의 메모장</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/blog/tags">Tags</a><a class="navbar__item navbar__link" href="/blog/archive">Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/devyuseon" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/05/05/deserialize-polymorphism-subclasses">json을 다형성 적용된 클래스로 역직렬화 하기</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/2024/04/08/Process.waitfor-dealock-occur">Process.waitFor() 이 영원히 끝나지 않는다.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/03/30/springrestdocs-openapi3">Spring REST Docs + OAS 적용기</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/03/11/design-access-control-strategy">통합 접근 제어 전략을 설계 해보다.</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/02/04/troubleshooting-express-no-response">[TroubleShooting] express가 응답을 보내지 않았다. 왜..?</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/01/29/first-opensearch-contribute-docker-compose"> 오픈소스 첫 기여 ✨</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/01/02/java-no-stacktrace">[Java] 에러 메시지, Stacktrace가 생략되는 문제</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="https://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="https://schema.org/BlogPosting"><meta itemprop="description" content="자바에서 외부 프로세스에 exec() 명령을 전달하고, waitFor() 메서드 사용시 행이 걸리는 이슈"><header><h1 class="title_f1Hy" itemprop="headline">Process.waitFor() 이 영원히 끝나지 않는다.</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-04-08T00:00:00.000Z" itemprop="datePublished">April 8, 2024</time> · <!-- -->8 min read</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>Java에서 command를 실행하는 부분에서, 행이 걸리는 이슈가 발생했다. 아무 오류도 나타나지 않고 시스템이 행이 걸려버렸다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="문제-상황">문제 상황<a href="#문제-상황" class="hash-link" aria-label="Direct link to 문제 상황" title="Direct link to 문제 상황">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token class-name" style="color:hsl(35, 99%, 36%)">Process</span><span class="token plain"> process </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token class-name" style="color:hsl(35, 99%, 36%)">Runtime</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">getRuntime</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">exec</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">command</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">process</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">waitFor</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"> </span><span class="token comment" style="color:hsl(230, 4%, 64%)">// 여기가 문제</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>waitFor()</code> 가 끝나지 않는 문제가 있었다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="원인">원인<a href="#원인" class="hash-link" aria-label="Direct link to 원인" title="Direct link to 원인">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="문제가-된-부분">문제가 된 부분<a href="#문제가-된-부분" class="hash-link" aria-label="Direct link to 문제가 된 부분" title="Direct link to 문제가 된 부분">​</a></h3>
<p>원인은 생각보다 금방 찾을 수 있었다. 유명한 이슈였다..! <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html" target="_blank" rel="noopener noreferrer">JavaDoc</a>에도 이런 내용이 있다.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><blockquote>
<p>Because some native platforms only provide limited buffer size for standard input and output streams, failure to promptly write the input stream or read the output stream of the subprocess may cause the subprocess to block, or even deadlock.</p>
</blockquote><p>일부 네이티브 플랫폼은 표준 입력 및 출력 스트림에 대해 제한된 버퍼 크기만을 제공하기 때문에, 입력 스트림을 즉시 작성하거나 하위 프로세스의 출력 스트림을 읽지 않으면 하위 프로세스가 차단되거나 심지어 교착 상태에 빠질 수 있다.</p></div></div>
<p>Process 클래스를 통해 서브 프로세스를 생성하고, <code>exec()</code> 으로 실행한다. 하위프로세스는 Process 클래스의 <code>getInputStream()</code>과 <code>getErrorStream()</code> 메서드를 통해 출력 메시지를 부모 프로세스에 보낸다. 그리고 문제가 된 코드는 아래 방식으로 출력과 오류를 <strong>순차적</strong>으로 읽고 처리한다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">new</span><span class="token plain"> </span><span class="token class-name" style="color:hsl(35, 99%, 36%)">BufferedReader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">new</span><span class="token plain"> </span><span class="token class-name" style="color:hsl(35, 99%, 36%)">InputStreamReader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">process</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">getInputStream</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;UTF-8&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">// 로그에 쓰는 작업 ..</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">new</span><span class="token plain"> </span><span class="token class-name" style="color:hsl(35, 99%, 36%)">BufferedReader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token keyword" style="color:hsl(301, 63%, 40%)">new</span><span class="token plain"> </span><span class="token class-name" style="color:hsl(35, 99%, 36%)">InputStreamReader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">process</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">getErrorStream</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;UTF-8&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">// 로그에 쓰는 작업 ..</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>그런데 이때 만약 실행되는 프로세스가 많은 양의 출력을 생성하고, 이를 빠르게 읽어들이지 않으면 버퍼가 가득 차서 프로세스가 블록될 수 있다.</p>
<p>데드락이 발생하는 상황은 다음과 같다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="데드락이-발생하는-상황">데드락이 발생하는 상황<a href="#데드락이-발생하는-상황" class="hash-link" aria-label="Direct link to 데드락이 발생하는 상황" title="Direct link to 데드락이 발생하는 상황">​</a></h3>
<ol>
<li><strong>외부 프로세스 실행</strong>: 자바에서 <code>Runtime.exec()</code> 또는 <code>ProcessBuilder.start()</code>를 사용하여 외부 프로세스를 실행, 자바 애플리케이션(부모 프로세스)과 외부 프로세스(자식 프로세스) 사이에는 표준 입력, 출력, 오류 스트림을 통한 데이터 교환이 가능해진다.</li>
<li><strong>데이터 쓰기 및 읽기 시작</strong>: 자바 애플리케이션은 외부 프로세스의 표준 출력과 표준 오류 스트림을 읽기 시작한다. 동시에 외부 프로세스는 실행 결과를 표준 출력 및 표준 오류 스트림으로 출력하기 시작할 수 있다.</li>
<li><strong>버퍼 가득 참</strong>: 외부 프로세스가 많은 양의 데이터를 빠르게 출력하면 표준 출력 또는 표준 오류 스트림의 버퍼가 가득 찬다. 이 상태에서 자바 애플리케이션이 버퍼에서 데이터를 빨리 읽지 않으면 외부 프로세스는 버퍼에 데이터를 더이상 쓸 수 없게 된다.</li>
<li><strong>자바 애플리케이션 처리 지연</strong>: 만약 자바 애플리케이션이 표준 출력만 읽고 표준 오류는 나중에 읽으려고 한다면, 표준 오류의 버퍼가 가득 차 있으면서 표준 출력의 처리가 완료되지 않는 상황이 발생할 수 있다. 이는 외부 프로세스가 더 이상 진행되지 못하게 하고, 자바 애플리케이션도 외부 프로세스의 종료를 기다리는 데드락 상태에 빠지게 한다.</li>
<li><strong>데드락</strong>: 결국 외부 프로세스는 표준 출력 또는 표준 오류 스트림으로 데이터를 더 출력할 수 없어 실행을 멈추고, 자바 애플리케이션은 외부 프로세스의 완전한 종료를 기다리면서 더 이상 진행하지 못한다. 결과적으로, 두 프로세스 모두 서로의 다음 단계를 기다리는 상태에 빠지게 되어 데드락이 발생한다.</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="해결방법">해결방법<a href="#해결방법" class="hash-link" aria-label="Direct link to 해결방법" title="Direct link to 해결방법">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="내용이-필요-없을-경우---close">내용이 필요 없을 경우 - close()<a href="#내용이-필요-없을-경우---close" class="hash-link" aria-label="Direct link to 내용이 필요 없을 경우 - close()" title="Direct link to 내용이 필요 없을 경우 - close()">​</a></h3>
<p>입력스트림, 출력스트림을 사용할 일이 없다면 <code>waitFor()</code> 전에 스트림을 다 닫아준다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token class-name" style="color:hsl(35, 99%, 36%)">Process</span><span class="token plain"> process </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> processBuilder</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">start</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"> </span><span class="token comment" style="color:hsl(230, 4%, 64%)">// or</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token class-name" style="color:hsl(35, 99%, 36%)">Process</span><span class="token plain"> process </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token class-name" style="color:hsl(35, 99%, 36%)">Runtime</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">getRuntime</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">exec</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">command</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">process</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">getErrorStream</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">close</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">process</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">getInputStream</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">close</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">process</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">getOutputStream</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">close</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">process</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">waitFor</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="apache-commons-exec-사용">Apache Commons Exec 사용<a href="#apache-commons-exec-사용" class="hash-link" aria-label="Direct link to Apache Commons Exec 사용" title="Direct link to Apache Commons Exec 사용">​</a></h3>
<div class="language-gradle codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-gradle codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token comment" style="color:hsl(230, 4%, 64%)">// build.gradle</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">implementation</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;org.apache.commons:commons-exec:1.3&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>의존성을 추가하고, 사용하면 해결법을 직접 구현할 필요 없이 안전하게 사용 가능하다고 한다. 나는 다른 방법을 사용해 해결했다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="스레드-병렬처리">스레드 병렬처리<a href="#스레드-병렬처리" class="hash-link" aria-label="Direct link to 스레드 병렬처리" title="Direct link to 스레드 병렬처리">​</a></h3>
<ul>
<li>외부 프로세스의 표준 출력 스트림을 읽는 스레드를 생성하고 시작한다.</li>
<li>외부 프로세스의 표준 에러 스트림을 읽기 위한 또 다른 별도의 스레드를 생성하고 시작한다.</li>
<li>두 스레드를 병렬 처리 한다.</li>
</ul>
<p>이렇게 처리하면 한 스트림의 버퍼가 가득 차 블록되더라도 다른 스트림의 데이터를 계속 읽을 수 있어 데드락을 방지할 수 있다.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-redirect-error-stream">✅ Redirect Error Stream<a href="#-redirect-error-stream" class="hash-link" aria-label="Direct link to ✅ Redirect Error Stream" title="Direct link to ✅ Redirect Error Stream">​</a></h3>
<p>나는 이 방법을 이용해 처리했다.</p>
<p><strong>ProcessBuilder</strong>의 <code>redirectErrorStream(true)</code> 를 사용해 표준 에러 스트림을 표준 출력 스트림으로 리다이렉션 해 단일 스트림으로 모든 출력을 읽을 수 있도록 한다.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token class-name" style="color:hsl(35, 99%, 36%)">ProcessBuilder</span><span class="token plain"> pb </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">new</span><span class="token plain"> </span><span class="token class-name" style="color:hsl(35, 99%, 36%)">ProcessBuilder</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">command</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">pb</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token function" style="color:hsl(221, 87%, 60%)">redirectErrorStream</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">true</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">;</span><span class="token plain"> </span><span class="token comment" style="color:hsl(230, 4%, 64%)">// 표준 에러 스트림을 표준 출력 스트림으로 리다이렉션</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>두 스트림을 하나의 스트림으로 처리하면, 표준 출력을 계속 읽어낼때 표준 에러 스트림에서 발생하는 데이터도 처리되기 때문에 버퍼를 지속적으로 비워줄 수 있다.</p>
<p>Runtime으로 작성되어 있던 코드를 ProcessBuilder를 사용하도록 해주고, <code>redirectErrorStream(true)</code> 로 설정하니 문제가 해결되었다.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="참고자료">참고자료<a href="#참고자료" class="hash-link" aria-label="Direct link to 참고자료" title="Direct link to 참고자료">​</a></h2>
<ul>
<li><a href="https://d2.naver.com/helloworld/1113548" target="_blank" rel="noopener noreferrer">https://d2.naver.com/helloworld/1113548</a></li>
<li><a href="https://stackoverflow.com/questions/5483830/process-waitfor-never-returns" target="_blank" rel="noopener noreferrer">https://stackoverflow.com/questions/5483830/process-waitfor-never-returns</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/8/docs/api/java/lang/Process.html</a></li>
</ul></div></article><div></div><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2024/05/05/deserialize-polymorphism-subclasses"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">json을 다형성 적용된 클래스로 역직렬화 하기</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2024/03/30/springrestdocs-openapi3"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Spring REST Docs + OAS 적용기</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#문제-상황" class="table-of-contents__link toc-highlight">문제 상황</a></li><li><a href="#원인" class="table-of-contents__link toc-highlight">원인</a><ul><li><a href="#문제가-된-부분" class="table-of-contents__link toc-highlight">문제가 된 부분</a></li><li><a href="#데드락이-발생하는-상황" class="table-of-contents__link toc-highlight">데드락이 발생하는 상황</a></li></ul></li><li><a href="#해결방법" class="table-of-contents__link toc-highlight">해결방법</a><ul><li><a href="#내용이-필요-없을-경우---close" class="table-of-contents__link toc-highlight">내용이 필요 없을 경우 - close()</a></li><li><a href="#apache-commons-exec-사용" class="table-of-contents__link toc-highlight">Apache Commons Exec 사용</a></li><li><a href="#스레드-병렬처리" class="table-of-contents__link toc-highlight">스레드 병렬처리</a></li><li><a href="#-redirect-error-stream" class="table-of-contents__link toc-highlight">✅ Redirect Error Stream</a></li></ul></li><li><a href="#참고자료" class="table-of-contents__link toc-highlight">참고자료</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>